name: 'On Main Release'

on:
  push: 
    branches:
      - 'main'

jobs:
  check:
    name: 'check stuff'
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.early.outcome }}
    steps:
      - name: 'Load Repository'
        uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      - id: early
        run: git log | head - -n 5 | python3 version_state_checker.py
        shell: /usr/bin/bash {0}

  build:
    name: 'Actual Stuff'
    needs: check
    permissions: write-all
    if: needs.check.outputs.status == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: 'Load Repository'
        uses: actions/checkout@v4

      - name: 'Have Maven Shut Up'
        run: echo "--batch-mode" >> .mvn/maven.config
      
      - name: 'Setup Java & Maven'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 'Packge all the stuff'
        run: mvn package

      - run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      - name: 'Make release'
        run: gh release create $(cat version_value) --generate-notes ./target/*.jar
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Update version'
        run: python3 version_handler.py min

      - name: 'Add Version & Commit'
        run: |
          git add version_value
          git commit -m "put release $(cat version_value)"

      - name: 'Push To Main'
        run: git push
          
